<link rel="stylesheet" href="../css/preview.css" />

<section aria-labelledby="complete-title">
  <h2 id="complete-title" class="section-title">All done ğŸ‰</h2>
  <p class="mt-8">
    Your data has been saved locally. What would you like to do next?
  </p>
  <div class="actions__extras">
    <button id="btnPreview" class="btn" type="button">
      Preview Master Customer Summary
    </button>
    <button class="btn btn--ghost" id="btn-export" type="button">
      Export JSON
    </button>
    <p class="text-muted" id="tip" style="margin: 0">
      Tip: â€œPreview PDFâ€ opens a print-friendly preview. â€œGenerate PDFâ€ opens
      your browserâ€™s print dialog so you can save as PDF.
    </p>
  </div>
  <!-- Preview modal -->
  <dialog id="previewModal" aria-label="MAOS Preview">
    <div class="pv-header">
      <div class="pv-title">Master Customer Summary â€” Preview (Read only)</div>

      <button id="generatePdfBtn" type="button" class="btn primary">
        Generate PDF
      </button>

      <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
      <script>
        document
          .getElementById("generatePdfBtn")
          .addEventListener("click", async () => {
            const iframe = document.getElementById("previewFrame");
            if (!iframe || !iframe.contentDocument) {
              alert("Preview not loaded.");
              return;
            }
            const doc = iframe.contentDocument.documentElement.cloneNode(true);
            if (!doc.hasAttribute("lang")) doc.setAttribute("lang", "en");
            if (!doc.querySelector("title")) {
              const title = doc.ownerDocument.createElement("title");
              title.textContent = "Master Customer Summary Preview";
              doc.querySelector("head").appendChild(title);
            }
            doc.querySelectorAll("script").forEach((s) => s.remove());
            const container = document.createElement("div");
            container.appendChild(doc);
            html2pdf()
              .set({
                margin: 0.5,
                filename: "Master-Customer-Summary.pdf",
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: {
                  unit: "in",
                  format: "a4",
                  orientation: "portrait",
                },
                pagebreak: { mode: ["avoid-all", "css", "legacy"] },
              })
              .from(container)
              .save();
          });
      </script>

      <button id="closePreview" class="pv-close" aria-label="Close">âœ•</button>
    </div>

    <iframe
      id="previewFrame"
      src=""
      title="MAOS Preview"
      referrerpolicy="no-referrer"
    ></iframe>
  </dialog>

  <!-- Scripts -->
  
  <script type="module" src="./js/preview.js"></script>
  <script type="module" src="./js/load_json_to_forms.js"></script>
</section>
