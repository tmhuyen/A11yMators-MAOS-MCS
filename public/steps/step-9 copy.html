<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAOS ‚Äì Complete</title>

  <!-- Styles shared -->
  <link rel="stylesheet" href="../css/preview.css" />

  <!-- Inline styles for this step -->
  <style>
    :root {
      --brand: #e31e2f;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #ffffff;
      --bg-alt: #fbfcff;
    }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }

    .container { max-width: 1040px; margin: 24px auto; padding: 0 16px; }
    .section-title { font-size: 22px; font-weight: 800; margin: 0; }
    .mt-8 { margin-top: 8px; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }

    .grid { display: grid; }
    .three { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--bg); cursor: pointer; font-weight: 600;
      transition: box-shadow .15s ease, transform .02s ease;
      min-height: 40px;
    }
    .btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--brand); border-color: var(--brand); color: #fff; }
    .btn.ghost { background: var(--bg); color: var(--text); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }

    .tip {
      padding: 12px 14px; background: var(--bg-alt); border: 1px solid #e6eefc; border-radius: 10px;
      color: #374151; font-size: 13px;
    }

    /* Modal (native <dialog>) */
    dialog#previewModal {
      width: min(1100px, 96vw); height: min(90vh, 860px); border: 0;
      padding: 0; border-radius: 14px; overflow: hidden;
      box-shadow: 0 16px 64px rgba(0,0,0,.18);
    }
    dialog::backdrop { background: rgba(0,0,0,.35); }

    .pv-header {
      display: flex; align-items: center; gap: 12px; justify-content: space-between;
      padding: 12px 12px; border-bottom: 1px solid var(--border); background: #fff;
    }
    .pv-title { font-weight: 700; font-size: 15px; }
    .pv-actions { display: flex; gap: 8px; align-items: center; }
    .pv-close {
      border: 1px solid var(--border); background:#fff; border-radius: 8px; width: 36px; height: 36px; cursor: pointer;
      font-size: 18px; line-height: 1;
    }

    #previewFrame {
      width: 100%; height: calc(90vh - 60px); border: 0; background: #f8fafc;
    }

    /* Ensure print keeps colors inside preview frame */
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>

  <!-- html2pdf (latest 0.10.x) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>
  <main class="container" aria-labelledby="complete-title">
    <h2 id="complete-title" class="section-title">All done üéâ</h2>
    <p class="mt-8">Your data has been saved locally. What would you like to do next?</p>

    <div class="mt-16 grid three">
      <button id="btnPreview" class="btn" type="button">Preview Master Customer Summary</button>
      <button id="btnGenerate" class="btn primary" type="button">Generate PDF</button>
      <button id="btn-export" class="btn ghost" type="button">Export JSON</button>
    </div>

    <div class="mt-16 tip" id="tip">
      Tip: <strong>Preview</strong> m·ªü b·∫£n xem tr∆∞·ªõc nhi·ªÅu trang. <strong>Generate PDF</strong> t·∫°o file PDF t·∫£i v·ªÅ t·ª´ n·ªôi dung preview.
    </div>
  </main>

  <!-- Modal -->
  <dialog id="previewModal" aria-label="MAOS Preview">
    <div class="pv-header">
      <div class="pv-title">Master Customer Summary ‚Äî Preview (Read only)</div>
      <div class="pv-actions">
        <button id="modalGenerate" class="btn primary" type="button">Generate PDF</button>
        <button id="closePreview" class="pv-close" aria-label="Close">‚úï</button>
      </div>
    </div>
    <iframe id="previewFrame" src="" title="MAOS Preview" referrerpolicy="no-referrer"></iframe>
  </dialog>

  <!-- Your app scripts -->
  <script type="module" src="../js/preview.js"></script>
  <script src="../js/load_json_to_forms.js"></script>

  <!-- Page logic -->
  <script>
    const modal = document.getElementById('previewModal');
    const iframe = document.getElementById('previewFrame');
    const btnPreview = document.getElementById('btnPreview');
    const btnGenerate = document.getElementById('btnGenerate');       // top button
    const modalGenerate = document.getElementById('modalGenerate');    // button in modal
    const closePreview = document.getElementById('closePreview');

    // Open preview modal & ensure preview.html is loaded (which itself loads all steps)
    async function openPreview() {
      if (!iframe.src) {
        // preview.html ph·∫£i t·ª± n·∫°p step-1..4 v√† b·ªçc .a4-page
        iframe.src = '../steps/preview.html';
      }
      await waitForIframe(iframe);
      if (!modal.open) modal.showModal();
    }

    btnPreview.addEventListener('click', openPreview);
    closePreview.addEventListener('click', () => modal.close());

    // Top-level Generate PDF uses the same routine (it will open/prepare preview if needed)
    btnGenerate.addEventListener('click', async () => {
      await openPreview();
      await generatePdfFromPreview();
    });

    // Modal Generate PDF
    modalGenerate.addEventListener('click', generatePdfFromPreview);

    // Helpers
    function waitForIframe(ifr) {
      return new Promise((resolve, reject) => {
        try {
          // If already ready
          if (ifr.contentDocument && ifr.contentDocument.readyState === 'complete') {
            resolve();
            return;
          }
          const onload = () => { cleanup(); resolve(); };
          const onerror = (e) => { cleanup(); reject(e); };
          function cleanup() { ifr.removeEventListener('load', onload); ifr.removeEventListener('error', onerror); }
          ifr.addEventListener('load', onload);
          ifr.addEventListener('error', onerror);
        } catch (e) { reject(e); }
      });
    }

    async function generatePdfFromPreview() {
      const triggerButtons = [btnGenerate, modalGenerate];
      const setBusy = (busy) => {
      triggerButtons.forEach(b => {
        if (!b) return;
        if (busy) { b.dataset._txt = b.textContent; b.textContent = 'Generating...'; b.disabled = true; }
        else { b.textContent = b.dataset._txt || 'Generate PDF'; b.disabled = false; }
      });
      };

      try {
      setBusy(true);

      // Ensure iframe ready
      await waitForIframe(iframe);

      const doc = iframe.contentDocument;
      if (!doc) throw new Error('Preview not loaded');

      const stepContainer = doc.getElementById('step-container');
      if (!stepContainer) throw new Error('Content container not found');

      const pages = stepContainer.querySelectorAll('.a4-page');
      if (!pages.length) {
        alert('Preview ch∆∞a s·∫µn s√†ng (kh√¥ng t√¨m th·∫•y .a4-page). M·ªü Preview l·∫°i gi√∫p m√¨nh nh√©.');
        setBusy(false);
        return;
      }

      // Build a clean PDF DOM
      const pdfContainer = document.createElement('div');
      pdfContainer.style.cssText = `
        width: 210mm;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
        line-height: 1.4;
        color: #000;
        background: #fff;
        margin: 0;
        padding: 0;
      `;

      pages.forEach((page, idx) => {
        const clone = page.cloneNode(true);

        // Strip interactive controls inside preview
        clone.querySelectorAll('script, button, [data-action]').forEach(el => el.remove());

        // Copy the original width, min-height, padding, etc. from the preview page
        // If you want to keep the exact preview size, copy computed styles
        const computed = doc.defaultView.getComputedStyle(page);
        clone.style.cssText = `
        width: ${computed.width};
        min-height: ${computed.minHeight};
        margin: ${computed.margin};
        padding: ${computed.padding};
        background: ${computed.background};
        page-break-after: ${idx < pages.length - 1 ? 'always' : 'auto'};
        page-break-inside: avoid;
        box-sizing: ${computed.boxSizing};
        `;

        // Tables
        clone.querySelectorAll('table').forEach((t, i) => {
        const tComputed = doc.defaultView.getComputedStyle(page.querySelectorAll('table')[i]);
        t.style.cssText = `
          width: ${tComputed.width};
          border-collapse: ${tComputed.borderCollapse};
          font-size: ${tComputed.fontSize};
          page-break-inside: avoid;
        `;
        });
        clone.querySelectorAll('td, th').forEach((cell, i) => {
        // Try to match cell style from preview
        const origCell = page.querySelectorAll('td, th')[i];
        if (origCell) {
          const c = doc.defaultView.getComputedStyle(origCell);
          cell.style.cssText = `
          border: ${c.border};
          padding: ${c.padding};
          vertical-align: ${c.verticalAlign};
          word-wrap: ${c.wordWrap};
          `;
        }
        });

        pdfContainer.appendChild(clone);
      });

      // html2pdf options
      const opt = {
        margin: [0, 0, 0, 0], // No extra margin, since preview already has it
        filename: 'Master-Customer-Summary.pdf',
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: {
        scale: 1.5,
        useCORS: true,
        letterRendering: true,
        allowTaint: true,
        scrollX: 0,
        scrollY: 0
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
        pagebreak: { mode: ['avoid-all','css'], avoid: 'table' }
      };

      await html2pdf().set(opt).from(pdfContainer).save();
      } catch (e) {
      console.error('PDF generation error:', e);
      alert('Error generating PDF. Please try again.');
      } finally {
      setBusy(false);
      }
    }
  </script>
</body>
</html>
