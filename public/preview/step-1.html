<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MAOS – Master Customer Summary</title>
    <link rel="stylesheet" href="./css/styles.css" />

    <!-- Hide preview/export/tip by default -->
    <style>
      #btnPreview,
      #btn-export,
      #tip {
        display: none;
      }
      /* Flex layout for action bar */
      .actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 24px;
      }
      .actions__spacer {
        flex: 1 1 auto;
      }
      .actions__extras {
        display: inline-flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      #btnPreview.btn,
      #btn-export.btn {
        white-space: nowrap;
      }
      @media (max-width: 640px) {
        .actions {
          gap: 8px;
        }
        .actions__extras {
          width: 100%;
          justify-content: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1 class="page-title">Master Customer Summary</h1>

      <div class="progress-bar" aria-hidden="true">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>

      <div
        class="right"
        id="stepIndicator"
        aria-live="polite"
        style="text-align: right"
      >
        Step 1 of 7
      </div>

      <div
        id="status"
        class="status status--info mt-16"
        role="status"
        aria-live="polite"
      >
        Required fields are marked with <span class="req">*</span>.
      </div>

      <div
        id="errorSummary"
        class="status status--error mt-16"
        hidden
        role="alert"
        tabindex="-1"
      ></div>

      <div id="step-container" class="section-card" tabindex="-1"></div>
    </main>

    <!-- Actions block moved outside <main> -->
    <div class="actions" aria-label="Wizard actions">
      <button id="prevBtn" class="btn btn-secondary" type="button">
        Previous
      </button>
      <button id="nextBtn" class="btn btn-primary" type="button">Next</button>

      <div class="actions__spacer" aria-hidden="true"></div>

      <div class="actions__extras">
        <button id="btnPreview" class="btn" type="button">
          Preview Master Customer Summary
        </button>
        <button class="btn btn--ghost" id="btn-export" type="button">
          Export JSON
        </button>
        <p class="text-muted" id="tip" style="margin: 0">
          Tip: “Preview PDF” opens a print-friendly preview. “Generate PDF”
          opens your browser’s print dialog so you can save as PDF.
        </p>
      </div>
    </div>

    <!-- Preview modal moved outside <main> -->
    <dialog id="previewModal" aria-label="MAOS Preview">
      <div class="pv-header">
        <div class="pv-title">
          Master Customer Summary — Preview (Read only)
        </div>

        <button id="generatePdfBtn" type="button" class="btn primary">
          Generate PDF
        </button>

        <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
        <script>
          document
            .getElementById("generatePdfBtn")
            .addEventListener("click", async () => {
              const iframe = document.getElementById("previewFrame");
              if (!iframe || !iframe.contentDocument) {
                alert("Preview not loaded.");
                return;
              }
              const doc =
                iframe.contentDocument.documentElement.cloneNode(true);
              if (!doc.hasAttribute("lang")) doc.setAttribute("lang", "en");
              if (!doc.querySelector("title")) {
                const title = doc.ownerDocument.createElement("title");
                title.textContent = "Master Customer Summary Preview";
                doc.querySelector("head").appendChild(title);
              }
              doc.querySelectorAll("script").forEach((s) => s.remove());
              const container = document.createElement("div");
              container.appendChild(doc);
              html2pdf()
                .set({
                  margin: 0.5,
                  filename: "Master-Customer-Summary.pdf",
                  html2canvas: { scale: 2, useCORS: true },
                  jsPDF: {
                    unit: "in",
                    format: "a4",
                    orientation: "portrait",
                  },
                  pagebreak: { mode: ["avoid-all", "css", "legacy"] },
                })
                .from(container)
                .save();
            });
        </script>

        <button id="closePreview" class="pv-close" aria-label="Close">✕</button>
      </div>

      <iframe
        id="previewFrame"
        src=""
        title="MAOS Preview"
        referrerpolicy="no-referrer"
      ></iframe>
    </dialog>

    <!-- Scripts -->
    <script type="module" src="./js/app.js"></script>
    <script type="module" src="./js/preview.js"></script>
    <script src="./js/load_json_to_forms.js"></script>
  </body>
</html>
